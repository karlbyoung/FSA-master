INSERT OVERWRITE INTO DEV.BUSINESS_OPERATIONS.DEMAND_PO (
	ID
    ,FK_ID
	,ORDER_NUMBER
	,UNIQUE_KEY
	,DDA
	,DDA_MODIFIED
	,ORIGINAL_DDA
    ,SEQUENCING_DDA
	,TRANS_TYPE
	,TOTAL_AMT
	,PRIORITY_LEVEL
	,NS_LINE_NUMBER
	,ITEM
	,ITEM_ID
	,COMPONENT_ITEM_ID
	,COMPONENT_ITEM
	,QUANTITY
	,TOTAL_AVAIL_QTY
	,COMPONENT_QTY_ORDERED
	,LOCATION
	,BO_STATUS
	,SOURCE_TYPE
	,SOURCE_LOAD_DATE_CURRENT
)

WITH DEMAND_PO_LOAD AS (
    SELECT *
    FROM DEV.BUSINESS_OPERATIONS.V_DEMAND_PO
    WHERE ORDER_NUMBER NOT IN ('Planning%')
    /* Multiyear Orders - START - 1 of 1 */
    AND IFNULL(SO_MATERIAL_SUPPORT_STATUS, '') NOT IN (
      	 'M/Y: Complete - (23-24)'
        ,'M/Y: Confirmed No Material - (23-24)'
        ,'M/Y: MMAF Not Received - (23-24)'
        ,'M/Y: Hold - (23-24)'
        ,'M/Y: Processed in SF - (23-24)'
        ,'M/Y: Implementation Complete'
    )
    /* Multiyear Orders - END - 1 of 1 */
    ORDER BY TRANSACTION_TYPE, DDA, UNIQUE_KEY
)

,"CTE_DEMAND_PO" AS (
  SELECT PRI.ID AS "FK_ID"
         ,DPO.ORDER_NUMBER
         ,UNIQUE_KEY
         ,DDA
         ,IFF(UPPER(TRANSACTION_TYPE) = 'ASSEMBLY',
              IFF(CAL.MIN_ADD_10 IS NULL, CAL.NEXT_BUSINESS_DAY, CAL.MIN_ADD_10),
              DDA) AS "DDA_MODIFIED"
         ,ORG_DDA
         ,TRANSACTION_TYPE
         ,TOTAL_AMT
         ,IFF(PRI.ID IS NULL, 4, PRIORITY_LEVEL) AS "PRIORITY_LEVEL"
         ,NS_LINE_NUMBER
         ,ITEM
         ,ITEM_ID
         ,COMPONENT_ITEM_ID
         ,COMPONENT_ITEM
         ,QTY_ORDERED
         ,TOTAL_AVAIL_QTY
         ,COMPONENT_QTY_ORDERED
         ,LOCATION
         ,BO_STATUS
         ,SOURCETYPE
         ,CURRENT_TIMESTAMP() AS INSERT_DATE
  		 ,CAL.*
  FROM DEMAND_PO_LOAD DPO
  INNER JOIN DEV."BUSINESS_OPERATIONS"."DEMAND_PRIORITY" PRI
          ON DPO.TRANSACTION_TYPE = PRI.SEQ_DESC
         AND DPO.PRIORITY_LEVEL = PRI.PRIORITY
  LEFT JOIN "DEV"."BUSINESS_OPERATIONS"."DIM_FULFILLMENT_CALENDAR" CAL
         ON CAL.RAW_DATE = DDA
)

,"CTE_SEQ_DDA" AS (
  SELECT ORDER_NUMBER, MIN(DDA_MODIFIED) AS MIN_DDA
  FROM  CTE_DEMAND_PO
  GROUP BY ORDER_NUMBER
)

SELECT ROW_NUMBER() OVER (ORDER BY TRANSACTION_TYPE, DDA) AS "ID"
      ,d.FK_ID
      ,d.ORDER_NUMBER
      ,d.UNIQUE_KEY
      ,d.DDA
      ,d.DDA_MODIFIED
      ,d.ORG_DDA
      ,s.MIN_DDA AS "SEQUENCING_DDA"
      ,d.TRANSACTION_TYPE
      ,d.TOTAL_AMT
      ,d.PRIORITY_LEVEL
      ,d.NS_LINE_NUMBER
      ,d.ITEM
      ,d.ITEM_ID
      ,d.COMPONENT_ITEM_ID
      ,IFF(d.COMPONENT_ITEM = '', NULL, d.COMPONENT_ITEM) AS "COMPONENT_ITEM"
      ,d.QTY_ORDERED
      ,d.TOTAL_AVAIL_QTY
      ,d.COMPONENT_QTY_ORDERED
      ,d.LOCATION
      ,d.BO_STATUS
      ,d.SOURCETYPE
      ,d.INSERT_DATE
FROM "CTE_DEMAND_PO" d
LEFT JOIN "CTE_SEQ_DDA" s
ON s.ORDER_NUMBER = d.ORDER_NUMBER