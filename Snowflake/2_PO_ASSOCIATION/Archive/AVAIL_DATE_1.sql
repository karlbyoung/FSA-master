CREATE OR REPLACE TABLE DEV.BUSINESS_OPERATIONS.SEQUENCING_PO_ASSIGN AS
SELECT  a.*
        EXCLUDE (SUM_ITEM_ROLLUP, PO_QUANTITY_TO_BE_RECEIVED)
        
              , CASE WHEN PO_INDICATOR = 1
                     THEN IFF(DDA < CURRENT_DATE(), CURRENT_DATE(), dda."MIN_SUB_12")
                  
                     WHEN PO_INDICATOR = 0
                     THEN IFF(dda90."MIN_SUB_12" < CURRENT_DATE(), today90."MIN_SUB_12", dda90."MIN_SUB_12")
                  
                     WHEN PO_INDICATOR = -1
                     THEN IFF(PO_RECEIVE_BY_DATE < CURRENT_DATE(), today."MIN_ADD_5", PO_RECEIVE_BY_DATE)
               ELSE NULL
               END AS "AVAIL_DATE"
     
             , SUM(QTY_ORDERED) OVER (PARTITION BY ITEM_ID, SIGN(REMAINING_QTY_ON_HAND)
                                      ORDER BY ROW_NO, ID
                                      ROWS BETWEEN UNBOUNDED PRECEDING
                                      AND CURRENT ROW) AS SUM_ITEM_ROLLUP
FROM (
    (SELECT *
          , IFF((REMAINING_QTY_ON_HAND >= 0 OR PO_ORDER_NUMBER IS NOT NULL), 1, 0) AS "PO_INDICATOR_ASSIGN"
          , MAX(PO_QUANTITY_TO_BE_RECEIVED) OVER (PARTITION BY ITEM_ID, PO_ORDER_NUMBER) AS "PO_TOTAL_QUANTITY_TO_BE_RECEIVED"
     FROM DEV.BUSINESS_OPERATIONS.GOOD_DEMAND)
     UNION
     (SELECT *
           , NULL AS PO_ORDER_NUMBER
           , NULL AS PO_QUANTITY_TO_BE_RECEIVED
           , NULL AS PO_QUANTITY_REMAINING
           , NULL AS PO_RECEIVE_BY_DATE
           , IFF((REMAINING_QTY_ON_HAND >= 0 OR PO_ORDER_NUMBER IS NOT NULL), 1, 0) AS "PO_INDICATOR"
           , NULL AS "PO_TOTAL_QUANTITY_TO_BE_RECEIVED"
     FROM DEV.BUSINESS_OPERATIONS.BAD_DEMAND
     WHERE UNIQUE_KEY NOT IN (SELECT UNIQUE_KEY FROM DEV.BUSINESS_OPERATIONS.GOOD_DEMAND))
    ) a
-- DDA
LEFT JOIN "DEV"."BUSINESS_OPERATIONS"."DIM_FULFILLMENT_CALENDAR" dda ON dda."RAW_DATE" = DDA
-- DDA + 90 DAYS
LEFT JOIN "DEV"."BUSINESS_OPERATIONS"."DIM_FULFILLMENT_CALENDAR" dda90 ON dda90."RAW_DATE" = DATEADD('day', 90, DDA)
-- TODAY
LEFT JOIN "DEV"."BUSINESS_OPERATIONS"."DIM_FULFILLMENT_CALENDAR" today ON today."RAW_DATE" = CURRENT_DATE()
-- TODAY + 90 DAYS
LEFT JOIN "DEV"."BUSINESS_OPERATIONS"."DIM_FULFILLMENT_CALENDAR" today90 ON today90."RAW_DATE" = DATEADD('day', 90, CURRENT_DATE())
ORDER BY ITEM_ID, ROW_NO, IFNULL(PO_ID, 0);